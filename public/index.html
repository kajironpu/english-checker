<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>英文添削ツール</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      max-width: 800px; 
      margin: 0 auto;
      line-height: 1.6;
    }
    h2 {
      color: #333;
    }
    textarea { 
      width: 100%; 
      height: 120px; 
      margin-top: 10px; 
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      resize: vertical;
    }
    button { 
      margin-top: 10px; 
      padding: 10px 20px; 
      font-size: 16px; 
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover { 
      background-color: #3367d6; 
    }
    button:disabled { 
      background-color: #cccccc; 
      cursor: not-allowed; 
    }
    .result { 
      margin-top: 20px; 
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .loading { 
      color: #666; 
      font-style: italic; 
    }
    .error { 
      color: #d93025; 
      font-weight: bold;
    }
    .score-high {
      color: #0f9d58;
    }
    .score-medium {
      color: #f4b400;
    }
    .score-low {
      color: #db4437;
    }
  </style>
</head>
<body>
  <h2>英文添削ツール</h2>
  <p>英文を入力して「添削する」ボタンを押してください。文法、自然さ、スコアを評価します。</p>
  <textarea id="inputText" placeholder="例: I am go to school yesterday."></textarea>
  <br>
  <button id="checkBtn">添削する</button>

  <div class="result">
    <p><strong>添削後:</strong> <span id="corrected"></span></p>
    <p><strong>スコア:</strong> <span id="score"></span></p>
    <p><strong>アドバイス:</strong> <span id="advice"></span></p>
  </div>

  <script>
    // DOM要素の取得
    const checkBtn = document.getElementById("checkBtn");
    const inputText = document.getElementById("inputText");
    const corrected = document.getElementById("corrected");
    const score = document.getElementById("score");
    const advice = document.getElementById("advice");

    // 処理中フラグ（レートリミット対策）
    let isProcessing = false;

    // イベントリスナー
    checkBtn.addEventListener("click", async () => {
      const text = inputText.value.trim();

      // 入力チェック
      if (!text) {
        alert("英文を入力してください");
        return;
      }

      // 処理中ならブロック（無料枠: Gemini 2.5 Flash-Lite は RPM=15）
      if (isProcessing) {
        advice.innerHTML = '<span class="error">前回のリクエストを処理中です。数秒後に再試行してください。</span>';
        return;
      }

      // ローディング状態に
      isProcessing = true;
      checkBtn.disabled = true;
      corrected.innerHTML = '<span class="loading">添削中...</span>';
      score.textContent = "";
      advice.textContent = "";

      try {
        const res = await fetch("/api/check", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json" 
          },
          body: JSON.stringify({ text })
        });

        // レートリミットエラー (429) の特別処理
        if (res.status === 429) {
          throw new Error("利用回数の制限に達しました。数分後に再試行してください。");
        }

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`エラー: ${res.status} ${res.statusText}\n${errorText}`);
        }

        const data = await res.json();
        
        // APIレスポンスの表示
        corrected.textContent = data.corrected;

        // スコアに色をつける
        const scoreValue = data.score;
        let scoreClass = "score-medium";
        if (scoreValue >= 80) scoreClass = "score-high";
        else if (scoreValue < 60) scoreClass = "score-low";
        score.innerHTML = `<span class="${scoreClass}">${scoreValue} / 100</span>`;

        advice.textContent = data.advice;

      } catch (error) {
        console.error("Fetch error:", error);
        corrected.innerHTML = '<span class="error">エラーが発生しました。</span>';
        score.textContent = "";
        advice.innerHTML = `<span class="error">${error.message}</span>`;
      } finally {
        // 処理終了
        isProcessing = false;
        checkBtn.disabled = false;
      }
    });
  </script>
</body>
</html>